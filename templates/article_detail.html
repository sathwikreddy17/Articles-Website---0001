{% extends "base.html" %}
{% block title %}{{ article.title }}{% endblock %}
{% block head_extra %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": {{ article.title|tojson }},
  "url": {{ url_for('main.article_by_slug', slug=article.slug, _external=True)|tojson }},
  "author": {
    "@type": "Person",
    "name": "Site Author"
  }
}
</script>
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('main.home') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('main.articles') }}">All Articles</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ article.title }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <article class="mb-4">
      <header class="mb-3">
        <h1 class="mb-2">{{ article.title }}</h1>
        <p class="text-muted small mb-2">{{ article.body|reading_time }}</p>
        <div class="d-flex gap-2 mb-2">
          <button id="copyLink" class="btn btn-sm btn-outline-secondary" type="button"><i class="bi bi-link-45deg"></i> Copy link</button>
          <a class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener" href="https://twitter.com/intent/tweet?url={{ url_for('main.article_by_slug', slug=article.slug, _external=True) | urlencode }}&text={{ article.title | urlencode }}"><i class="bi bi-twitter-x"></i> Tweet</a>
          <a class="btn btn-sm btn-outline-success" target="_blank" rel="noopener" href="https://www.linkedin.com/sharing/share-offsite/?url={{ url_for('main.article_by_slug', slug=article.slug, _external=True) | urlencode }}"><i class="bi bi-linkedin"></i> Share</a>
        </div>
        {% if article.tags %}
          <div>
            {% for t in article.tags.split(',') %}
              <a class="badge bg-secondary text-decoration-none" href="{{ url_for('main.by_tag', tag=t.strip()) }}">{{ t.strip() }}</a>
            {% endfor %}
          </div>
        {% endif %}
      </header>
      <div class="body">{{ article.body_html|safe }}</div>
    </article>
    {% if current_user.is_authenticated and current_user.is_admin %}
      <a class="btn btn-primary" href="{{ url_for('admin.edit', article_id=article.id) }}">‚úèÔ∏è Edit</a>
      <form action="{{ url_for('admin.delete', article_id=article.id) }}" method="post" style="display:inline">
        <button class="btn btn-danger" type="submit">üóëÔ∏è Delete</button>
      </form>
    {% endif %}
  </div>
  <aside class="col-lg-4 d-none d-lg-block">
    <div class="sticky-top" style="top: 6rem;">
      <div class="card">
        <div class="card-header">Contents</div>
        <div class="list-group list-group-flush small" id="toc"></div>
      </div>
    </div>
  </aside>
</div>

<script>
  // Copy link
  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('copyLink');
    if (!btn) return;
    btn.addEventListener('click', () => {
      navigator.clipboard.writeText("{{ url_for('main.article_by_slug', slug=article.slug, _external=True) }}").then(() => {
        btn.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied';
        setTimeout(() => btn.innerHTML = '<i class="bi bi-link-45deg"></i> Copy link', 1500);
      });
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.body');
    const toc = document.getElementById('toc');
    if (!container || !toc) return;
    function slugify(text){
      return text.toString().toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '')
        .replace(/[\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }
    const headers = container.querySelectorAll('h2, h3');
    headers.forEach(h => {
      const text = h.textContent || h.innerText;
      if (!h.id) { h.id = slugify(text); }
      const a = document.createElement('a');
      a.href = '#' + h.id;
      a.className = 'list-group-item list-group-item-action';
      a.textContent = text;
      if (h.tagName === 'H3') a.classList.add('ps-4');
      toc.appendChild(a);
    });
    if (!toc.children.length) {
      toc.innerHTML = '<div class="list-group-item text-muted">No sections</div>';
    }
  });
</script>
{% endblock %}
