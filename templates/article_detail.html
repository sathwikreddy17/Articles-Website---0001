{% extends "base.html" %}
{% block title %}{{ article.title }}{% endblock %}
{% block head_extra %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": {{ article.title|tojson }},
  "url": {{ url_for('main.article_by_slug', slug=article.slug, _external=True)|tojson }},
  "author": {
    "@type": "Person",
    "name": "Site Author"
  }
}
</script>
{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block content %}
<div class="full-bleed article-hero py-5 mb-4">
  <div class="container">
    <h1 class="display-5 fw-bold mb-3">{{ article.title }}</h1>
    <div class="d-flex flex-wrap align-items-center gap-2 text-muted mb-3">
      <span><i class="bi bi-clock"></i> {{ article.body|reading_time }}</span>
      <span>‚Ä¢</span>
      <span><i class="bi bi-link-45deg"></i> <a class="link-light text-decoration-underline" href="{{ url_for('main.article_by_slug', slug=article.slug) }}">Permalink</a></span>
    </div>
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button id="copyLink" class="btn btn-sm btn-outline-light" type="button"><i class="bi bi-link-45deg"></i> Copy link</button>
      <a class="btn btn-sm btn-outline-light" target="_blank" rel="noopener" href="https://twitter.com/intent/tweet?url={{ url_for('main.article_by_slug', slug=article.slug, _external=True) | urlencode }}&text={{ article.title | urlencode }}"><i class="bi bi-twitter-x"></i> Tweet</a>
      <a class="btn btn-sm btn-outline-light" target="_blank" rel="noopener" href="https://www.linkedin.com/sharing/share-offsite/?url={{ url_for('main.article_by_slug', slug=article.slug, _external=True) | urlencode }}"><i class="bi bi-linkedin"></i> Share</a>
    </div>
    {% if article.tags %}
      <div class="d-flex flex-wrap gap-2">
        {% for t in article.tags.split(',') %}
          <a class="badge rounded-pill text-bg-light text-decoration-none" href="{{ url_for('main.by_tag', tag=t.strip()) }}">{{ t.strip() }}</a>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <article class="mb-4">
      <div class="article-body body">{{ article.body_html|safe }}</div>
    </article>
    {% if current_user.is_authenticated and current_user.is_admin %}
      <a class="btn btn-primary" href="{{ url_for('admin.edit', article_id=article.id) }}">‚úèÔ∏è Edit</a>
      <form action="{{ url_for('admin.delete', article_id=article.id) }}" method="post" style="display:inline">
        <button class="btn btn-danger" type="submit">üóëÔ∏è Delete</button>
      </form>
    {% endif %}
  </div>
  <aside class="col-lg-4 d-none d-lg-block">
    <div class="sticky-top" style="top: 6rem;">
      <div class="margin-notes">
        <div class="mb-2 small text-muted">Sections</div>
        <div id="notes" class="d-flex flex-column gap-2"></div>
      </div>
    </div>
  </aside>
</div>

<script>
  // Copy link
  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('copyLink');
    if (!btn) return;
    btn.addEventListener('click', () => {
      navigator.clipboard.writeText("{{ url_for('main.article_by_slug', slug=article.slug, _external=True) }}").then(() => {
        btn.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied';
        setTimeout(() => btn.innerHTML = '<i class="bi bi-link-45deg"></i> Copy link', 1500);
      });
    });
  });
</script>

<script>
  // Build margin notes from H2 headings and sync active state as you scroll
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.article-body');
    const notes = document.getElementById('notes');
    if (!container || !notes) return;

    function slugify(text){
      return text.toString().toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '')
        .replace(/[\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }
    const headers = Array.from(container.querySelectorAll('h2'));
    const map = new Map();
    headers.forEach((h, i) => {
      const text = h.textContent || h.innerText;
      if (!h.id) { h.id = slugify(text); }
      const a = document.createElement('a');
      a.href = '#' + h.id;
      a.className = 'note-item link-underline link-underline-opacity-0';
      a.innerHTML = `<div class="note"><span class="index">${i+1}</span><span class="text">${text}</span></div>`;
      notes.appendChild(a);
      map.set(h, a);
    });
    if (!notes.children.length) {
      notes.innerHTML = '<div class="text-muted">No sections</div>';
      return;
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const el = entry.target;
        const link = map.get(el);
        if (link) link.classList.toggle('active', entry.isIntersecting);
      });
    }, { rootMargin: '0px 0px -70% 0px', threshold: 0.1 });
    headers.forEach(h => observer.observe(h));
  });
</script>

<script>
  // Elevate hero on scroll
  (function(){
    const hero = document.querySelector('.article-hero');
    if (!hero) return;
    const toggle = () => {
      if (window.scrollY > hero.offsetHeight * 0.4) hero.classList.add('hero-elevated');
      else hero.classList.remove('hero-elevated');
    };
    window.addEventListener('scroll', toggle, { passive: true });
    toggle();
  })();
</script>

{% endblock %}
